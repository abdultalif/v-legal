<?= $this->extend('layout/template'); ?><?= $this->section('content'); ?><div class="card card-primary card-outline">    <div class="card-header">        <h5 class="card-title">List Produk</h5>        <div class="card-tools">            <a href="<?= base_url(); ?>/pengajuan/detail/<?= $detail['pengajuan_id']; ?>"                class="btn btn-sm btn-default">                <i class="fa fa-arrow-left"></i> Ke Detail            </a>            <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#staticBackdrop">                <i class="fa fa-plus"></i> Tambah Data            </button>        </div>    </div>    <div class="table-responsive">        <table class="table table-bordered text-center table-striped w-100">            <thead>                <tr>                    <th>Nomor HS</th>                    <th>Nama Produk</th>                    <th>Volume (m3)</th>                    <th>Berat Bersih (kg)</th>                    <th>Unit</th>                    <th>Nilai</th>                    <th>Mata Uang</th>                    <th>Nama Ilmiah</th>                    <th>Negara Panen</th>                    <th>Hapus</th>                </tr>            </thead>            <tbody>                <?php if (!$list_detail) : ?>                <tr>                    <td colspan="10">Belum ada data</td>                </tr>                <?php else: ?>                <?php foreach ($list_detail as $row) : ?>                <tr>                    <td><?= $row['kode_hs']; ?>                    </td>                    <td><?= $row['nama_produk']; ?>                    </td>                    <td><?= round($row['volume'], 4); ?>                    </td>                    <td><?= round($row['berat'], 4); ?>                    </td>                    <td><?= $row['jumlah']; ?>                    </td>                    <td><?= number_format($row['nilai'], 2); ?>                    </td>                    <td><?= $row['mata_uang']; ?>                    </td>                    <td class="text-left">                    <?php                        $jenis = explode(';', $row['jenis_id']);                        $nama_ilmiah = '';                        foreach ($jenis as $jns) {                            if ($nama_ilmiah!='') {                                $nama_ilmiah = ';';                            }                            $nama_ilmiah .= $jenis_kayu->get($jns)['nama_jenis'];                            echo $nama_ilmiah;                        }                    ?>                    </td>                    <td class="text-left">                    <?php                        $negaraId = explode(';', $row['negara_id']);                        $negara_panen = '';                        foreach ($negaraId as $ngr) {                            if ($negara_panen!='') {                                $negara_panen = ';';                            }                            $negara_panen .= $negara->get($ngr)['nama_negara'];                            echo $negara_panen;                        }                    ?>                    </td>                    <td>                        <div class="text-center">                            <div class="btn-group">                                <button                                    data-id="<?= $row['id']; ?>"                                    type="button" class="btn btn-default btn-xs btn-edit">                                    <i class="fa fa-edit"></i>                                </button>                                <form                                    action="/detailpengajuan/delete/<?= $row['id']; ?>/<?= $row['pengajuan_id']; ?>"                                    method="post">                                    <?= csrf_field(); ?>                                    <input type="hidden" name="_method" value="DELETE">                                    <button type="submit" class="btn btn-default btn-xs"                                        onclick="return confirm('Confirm Delete ?');">                                        <i class="fa fa-trash fa-fw"></i>                                    </button>                                </form>                            </div>                        </div>                    </td>                </tr>                <?php endforeach; ?>                <?php endif; ?>            </tbody>            <tfoot>                <tr>                    <th colspan="2"></th>                    <th>                        <?= round($total['total_volume'], 4); ?>                    </th>                    <th>                        <?= round($total['total_berat'], 4); ?>                    </th>                    <th>                        <?= $total['total_jumlah']; ?>                    </th>                    <th><?= number_format($total['total_nilai'], 2); ?>                    </th>                    <th colspan="4"></th>                </tr>            </tfoot>        </table>    </div></div><div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1"    aria-labelledby="staticBackdropLabel" aria-hidden="true">    <div class="modal-dialog modal-lg modal-dialog-centered">        <div class="modal-content shadow-none">            <div class="modal-header">                <h5 class="modal-title" id="staticBackdropLabel">Tambah Data</h5>                <button type="button" class="close" data-dismiss="modal" aria-label="Close">                    <span aria-hidden="true">&times;</span>                </button>            </div>            <?= form_open('detailpengajuan/save', ['id'=>'form-detail','autocomplete'=>'off']); ?>            <?= csrf_field(); ?>            <input type="hidden" name="pengajuan_id"                value="<?= set_value('pengajuan_id', $detail['pengajuan_id']); ?>">            <input type="hidden" name="id" id="id"                value="<?= set_value('id'); ?>">            <div class="modal-body">                <div class="form-group">                    <label for="produk_id">Produk</label>                    <select                        class="form-control select2 <?= $validation->hasError('produk_id') ? 'is-invalid' : ''; ?>"                        name="produk_id" id="produk_id">                        <option value="" selected>- Pilih Produk -</option>                        <?php foreach ($produk as $p) : ?>                            <?php if($p['status'] == "1") : ?>                                <option value="<?= $p['produk_id']; ?>" <?= set_select('produk_id', $p['produk_id']); ?>><?= $p['kode_hs']; ?> | <?= $p['nama_produk']; ?></option>                            <?php endif; ?>                        <?php endforeach; ?>                    </select>                    <div class="invalid-feedback">                        <?= $validation->getError('produk_id'); ?>                    </div>                </div>                <div class="row row-cols-1 row-cols-sm-2">                    <div class="col">                        <div class="form-group">                            <label for="jenis_id">Jenis Kayu</label>                            <select multiple                                class="form-control select2 <?= $validation->hasError('jenis_id') ? 'is-invalid' : ''; ?>"                                name="jenis_id[]" id="jenis_id">                                <?php foreach ($kayu as $k) : ?>                                <option                                    value="<?= $k['jenis_id']; ?>"                                    <?= set_select('jenis_id', $k['jenis_id']); ?>>                                    <?= $k['nama_jenis']; ?>                                </option>                                <?php endforeach; ?>                            </select>                            <div class="invalid-feedback">                                <?= $validation->getError('jenis_id'); ?>                            </div>                        </div>                    </div>                    <div class="col">                        <div class="form-group">                            <label for="negara_id">Negara Panen</label>                            <div id="negara_wrapper"></div>                        </div>                    </div>                </div>                <div class="row">                    <div class="col">                        <div class="form-group">                            <label for="jumlah">Jumlah Unit</label>                            <input placeholder="Unit"                                class="form-control <?= $validation->hasError('jumlah') ? 'is-invalid' : ''; ?>"                                value="<?= old('jumlah'); ?>"                                type="text" name="jumlah" id="jumlah">                            <div class="invalid-feedback">                                <?= $validation->getError('jumlah'); ?>                            </div>                        </div>                    </div>                    <div class="col">                        <div class="form-group">                            <label for="volume">Volume (m3)</label>                            <input placeholder="Volume (m3)"                                class="form-control <?= $validation->hasError('volume') ? 'is-invalid' : ''; ?>"                                value="<?= old('volume'); ?>"                                type="text" name="volume" id="volume">                            <div class="invalid-feedback">                                <?= $validation->getError('volume'); ?>                            </div>                        </div>                    </div>                    <div class="col">                        <div class="form-group">                            <label for="berat">Berat Bersih (kg)</label>                            <input placeholder="Berat (kg)"                                class="form-control <?= $validation->hasError('berat') ? 'is-invalid' : ''; ?>"                                value="<?= old('berat'); ?>"                                type="text" name="berat" id="berat">                            <div class="invalid-feedback">                                <?= $validation->getError('berat'); ?>                            </div>                        </div>                    </div>                </div>                <div class="form-group">                    <label for="nilai">Nilai</label>                    <div class="input-group">                        <div class="input-group-prepend">                            <span class="input-group-text"> <?= $detail['mata_uang']; ?></span>                        </div>                        <input placeholder="Nilai"                            class="form-control <?= $validation->hasError('nilai') ? 'is-invalid' : ''; ?>"                            value="<?= old('nilai'); ?>"                            type="text" name="nilai" id="nilai">                        <div class="invalid-feedback">                            <?= $validation->getError('nilai'); ?>                        </div>                    </div>                </div>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>                <button type="submit" class="btn btn-primary">Simpan</button>            </div>            <?= form_close(); ?>        </div>    </div></div><?= $this->endSection(); ?><?= $this->section('addons'); ?><script>    function edit(id) {        let modal = $('#staticBackdrop'),            base_url = "<?=base_url()?>";        let dpid = $('#id'),            produk = $('#produk_id'),            jenis = $('#jenis_id'),            jumlah = $('#jumlah'),            volume = $('#volume'),            berat = $('#berat'),            nilai = $('#nilai');        modal.modal('show');        // Edit Modal        modal.find('.modal-title').text('Edit Detail ');        modal.find('.modal-footer .btn-primary').text('Ubah');        $.ajax({            url: base_url + "/detailpengajuan/get/" + id,            type: "GET",            success: function(data) {                let jns = data.jenis_id.split(";");                let ngr = data.negara_id.split(";");                jenis.val(jns).trigger('change');                setTimeout(function() {                    ngr.forEach(function(negaraId, index) {                        $('#negara_wrapper').find('select').eq(index).val(negaraId).trigger(                            'change');                    });                }, 500);                dpid.val(data.id);                produk.val(data.produk_id).trigger('change');                jumlah.val(data.jumlah);                volume.val(data.volume);                berat.val(data.berat);                nilai.val(data.nilai);            }        });        // Tambah Modal        modal.on('hidden.bs.modal', function() {            modal.find('.modal-title').text('Tambah Detail');            modal.find('.modal-footer .btn-primary').text('Simpan');            dpid.val('');            produk.val('').trigger('change');            jenis.val('').trigger('change');            jumlah.val('');            volume.val('');            berat.val('');            nilai.val('');        });    }    $('#staticBackdrop').on('hidden.bs.modal', function() {        $('input.is-invalid,select.is-invalid').removeClass('is-invalid');    });    function createSelect(jns) {        let nw = $('#negara_wrapper');        nw.html('');        for (var i = 0; i < jns; i++) {            let selectNegara = `                    <select                        class="form-control select2"                        name="negara_id[${i}]" id="negara_id[${i}]" required>                        <option value="" selected>- Negara Panen (${i+1}) -</option>                        <?php foreach ($getNegara as $gn) : ?>                        <option                            value="<?= $gn['negara_id']; ?>">                            <?= $gn['nama_negara']; ?>                        </option>                        <?php endforeach; ?>                    </select>                    <div class="my-2"></div>                    `;            nw.append(selectNegara);            $('#negara_wrapper').find('select').select2();        }    }    $('#staticBackdrop').on('shown.bs.modal', function() {        let j = "" + $('#jenis_id').val();        let jns = j.split(',').length;        if ($("#jenis_id").val() != "") {            createSelect(jns);        }    });    $(function() {        $('body').addClass('sidebar-collapse');        <?php if (session()->has('_ci_validation_errors')) : ?>        $('#staticBackdrop').modal('show');        <?php endif; ?>        $('#jenis_id,body #negara_id').select2({            maximumSelectionLength: 3,            formatSelectionTooBig: function(limit) {                return 'Maksimal 3 pilihan';            }        });        let selectJenis = $('#jenis_id');        selectJenis.on("change", function(e) {            let j = "" + $(this).val();            let jns = j.split(',').length;            let nw = $('#negara_wrapper');            if ($(this).val() != "") {                createSelect(jns);            } else {                nw.html('');            }        });        // Modal        $('body .btn-edit').on('click', function() {            let id = $(this).data('id');            edit(id);        });    });</script><?= $this->endSection();